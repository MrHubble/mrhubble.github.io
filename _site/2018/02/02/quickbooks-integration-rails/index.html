<!doctype html>
<html>

<head>
  <meta charset="utf-8">
  <title>Quickbooks integration with Rails</title>
  <link rel="stylesheet" href="/assets/css/styles.css">
</head>

<body>
  <nav>
  
  <a href="/" >Home</a>
  
  <a href="/about.html" >About</a>
  
  <a href="/blog.html" >Blog</a>
  
  <a href="/staff.html" >Staff</a>
  
  <a href="/rails.html" >Rails</a>
  
</nav>
  <h1>Quickbooks integration with Rails</h1>

<p>
  02 Feb 2018
  
  
</p>

<p>Quickbooks integration with Rails can prove to be quite challenging. It seems the Quickbooks API has undergone significant changes over the years and as a new Quickbooks developer you’ll be using Oauth2 (as opposed to Oauth1).</p>

<p>Previous versions of the API used XML, whereas the current version uses JSON.</p>

<p>The most popular Ruby gem is <a href="https://github.com/ruckus/quickbooks-ruby" target="_blank" rel="noopener">quickbooks-ruby</a>, however:</p>

<blockquote>
  <p>Intuit started the v3 API supporting both XML and JSON. However, new v3 API services such as Tax Service will only support JSON. This gem has roots in the v2 API, which was XML only, and hence was constructed supporting XML only.</p>

  <p>That said, the Tax Service is supported and other new v3-API-JSON-only services will be supported. Ideally, we would like to fully support JSON for all entities and services for the 1.0.0 release. Please jump in and contribute to help that aim.</p>
</blockquote>

<p><a href="https://github.com/ruckus/quickbooks-ruby#json-support" target="_blank" rel="noopener">quickbooks-ruby#json-support</a></p>

<p>The main problem with this gem is that oauth2 is currently not supported, however, it should be merged soon: <a href="https://github.com/ruckus/quickbooks-ruby/issues/389" target="_blank" rel="noopener">quickbooks-ruby/issues/389</a></p>

<p>I think the oauth2 branch of quickbooks-ruby will use <a href="https://rubygems.org/gems/oauth2/" target="_blank" rel="noopener">the oauth2 gem</a>. Whereas the author of qbo_api prefers <a href="https://rubygems.org/gems/rack-oauth2:" target="_blank" rel="noopener">rack-oauth2</a></p>

<blockquote>
  <p>I really won’t bother trying to re-invent the wheel by rolling your own OAuth2 code. That said, the OAuth2 2-legged process is simpler than the 3-legged OAuth 1a process and if you do want to roll your own OAuth2 code take a look at Intuit’s Python example for a good starting point.</p>

  <p>As for me, I’ll choose to leverage the Rack-OAuth2 gem as I like its ability to directly set endpoints.</p>
</blockquote>

<p><a href="http://minimul.com/access-the-quickbooks-online-api-with-oauth2.html">access-the-quickbooks-online-api-with-oauth2</a></p>

<p>You’re going to need to create a Quickbooks developer account, follow a guide such as: <a href="https://developer.intuit.com/hub/blog/2017/08/03/quick-start-quickbooks-online-rest-api-oauth-2-0">quick-start-quickbooks-online-rest-api-oauth-2-0</a></p>

<h1 id="putting-it-all-together">Putting it all together:</h1>

<p>So I’m going to take parts from:</p>

<ul>
  <li>https://developer.intuit.com/docs/00_quickbooks_online/2_build/10_authentication_and_authorization/10_oauth_2.0</li>
  <li>https://github.com/minimul/qbo_api/blob/master/example/app.rb</li>
  <li>https://github.com/ruckus/quickbooks-ruby/blob/389-oauth2/README.md</li>
  <li>https://github.com/IntuitDeveloper/OAuth2_RubyOnRails/blob/master/OAuth2/app/controllers/token_controller.rb</li>
</ul>

<h2 id="1-initiating-the-authorization-request">1. Initiating the authorization request</h2>

<p>Initiate the OAuth 2 process by redirecting the user to Intuit’s OAuth 2.0 server. The response is sent to the redirect_uri that you specified in the request.</p>

<p>Sample code:</p>

<pre><code class="ruby">#quickbooks_controller.rb
class QuickbooksController &lt; ApplicationController
    def index
    end

    def authenticate
        session[:state] = SecureRandom.uuid
        client = Quickbooks.new.oauth2_client
        grant_url = client.auth_code.authorize_url(response_type: "code", state: session[:state], scope: "com.intuit.quickbooks.accounting")
        redirect_to grant_url
    end

</code></pre>

<h2 id="2-exchange-code-for-refresh-and-access-tokens">2. Exchange code for refresh and access tokens</h2>

<p>After the app receives the authorization code, it exchanges the authorization code for refresh and access tokens.</p>

<h2 id="3-refreshing-the-access-token">3. Refreshing the access token</h2>

<blockquote>
  <p>Access tokens are valid for 3600 seconds (one hour), after which time you need to get a fresh one using the latest refresh_token returned to you from the previous request. When you request a fresh access token, always use the refresh token returned in the most recent token_endpoint response. Your previous refresh tokens expire 24 hours after you receive a new one. If an access_token is not requested during the current refresh_token 100 day lifetime, the refresh_token expires and access to the QuickBooks Online company terminates. As long as it hasn’t expired, the refresh_token can be reset as often as needed within a one year access window from the time the original access_token was generated. Access to the QuickBooks Online company terminates when the current refresh_token expires or at the end of the one year access window from the time the original access_token was generated, whichever is earlier. When access terminates, your app must ask the user to reauthorize the connection.</p>
</blockquote>

<p><a href="https://developer.intuit.com/docs/00_quickbooks_online/2_build/10_authentication_and_authorization/10_oauth_2.0">above taken from various parts of the Quickbooks OAuth 2.0 guide</a></p>

<h2 id="4-encryption">4. Encryption</h2>

<p>Encrypt and store the refresh token and realmId in persistent memory. Encrypt the refresh token with a symmetric algorithm (3DES or AES). AES is preferred. Store your AES key in your app, in a separate configuration file.</p>

<h2 id="5-moving-to-production">5. Moving to production</h2>

<ul>
  <li>Install ngrok.</li>
  <li>Run <code class="highlighter-rouge">ngrok http 3000 -region=au</code> (use your region) and add the URI as a redirect_uri in Quickbooks dev tools for the Production environment.</li>
</ul>

</body>

</html>